// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String        @id @default(cuid())
  email         String        @unique
  password      String
  name          String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  plan          String        @default("free")
  promptCopiesToday Int       @default(0)
  promptCopiesResetAt DateTime?
  growthContentToday Int      @default(0)
  growthContentResetAt DateTime?
  prompts       Prompt[]
  challenges    Challenge[]
  comments      Comment[]
  chatMembers   ChatMember[]
  chatMessages  ChatMessage[]
  joinRequests  JoinRequest[]
  notifications Notification[]
  events        Event[]
  growthTopics  GrowthTopic[]
  learningProgress LearningProgress[]
  searchHistory SearchHistory[]
  followers     Follow[]      @relation("UserFollowers")
  following     Follow[]      @relation("UserFollowing")
}

model Prompt {
  id                String         @id @default(cuid())
  userId            String
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  topic             String
  prompt            String
  category          String?        // PromptCategory: "writing", "coding", "marketing", etc.
  recommendedTools  String         // JSON array of tool IDs
  tips              String         // JSON array of tips
  imageUrl          String?        // Optional reference image URL
  isPublic          Boolean        @default(false) // true = 공개 등록, false = 개인 보관
  parentId          String?        // Reference to parent prompt for refined versions
  parent            Prompt?        @relation("PromptRefinements", fields: [parentId], references: [id], onDelete: Cascade)
  refinements       Prompt[]       @relation("PromptRefinements")
  aiProvider        String?        // AI provider used: "gpt", "claude", "grok"
  aiModel           String?        // Specific model used (e.g., "gpt-5", "claude-sonnet-4-5-20250929")
  views             Int            @default(0) // View count
  averageRating     Float?         // Average rating (1-5)
  ratingCount       Int            @default(0) // Number of ratings
  ratings           PromptRating[] // User ratings
  comments          Comment[]      // 댓글
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([userId])
  @@index([parentId])
  @@index([isPublic])
  @@index([aiProvider])
  @@index([category])
  @@index([views])
  @@index([averageRating])
}

model PromptRating {
  id        String   @id @default(cuid())
  promptId  String
  prompt    Prompt   @relation(fields: [promptId], references: [id], onDelete: Cascade)
  userId    String
  rating    Int      // 1-5 stars
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([promptId, userId]) // One rating per user per prompt
  @@index([promptId])
  @@index([userId])
}


model Challenge {
  id          String     @id @default(cuid())
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  description String
  codeSnippet String?    // Optional code snippet
  ideaDetails String?    // Optional idea details
  resumeUrl   String?    // URL to uploaded resume file
  contactInfo String     // Email or contact information
  tags        String     // JSON array of tags
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  comments    Comment[]
  chatRoom    ChatRoom?
  joinRequests JoinRequest[]

  @@index([userId])
}

model Comment {
  id          String    @id @default(cuid())
  challengeId String?
  challenge   Challenge? @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  promptId    String?
  prompt      Prompt?   @relation(fields: [promptId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  content     String
  parentId    String?   // 답글 기능을 위한 부모 댓글 ID
  parent      Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Comment[] @relation("CommentReplies")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([challengeId])
  @@index([promptId])
  @@index([userId])
  @@index([parentId])
}

model ChatRoom {
  id          String        @id @default(cuid())
  challengeId String        @unique
  challenge   Challenge     @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  members     ChatMember[]
  messages    ChatMessage[]
  events      Event[]
  whiteboards Whiteboard[]

  @@index([challengeId])
}

model ChatMember {
  id         String   @id @default(cuid())
  chatRoomId String
  chatRoom   ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       String   // "designer" or "developer"
  experience String   // Career/experience description
  isOwner    Boolean  @default(false) // Challenge creator is the owner
  joinedAt   DateTime @default(now())

  @@unique([chatRoomId, userId])
  @@index([chatRoomId])
  @@index([userId])
}

model ChatMessage {
  id         String   @id @default(cuid())
  chatRoomId String
  chatRoom   ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content    String
  fileUrl    String?  // URL to uploaded file/image
  fileName   String?  // Original file name
  fileType   String?  // MIME type (image/png, application/pdf, etc.)
  createdAt  DateTime @default(now())

  @@index([chatRoomId])
  @@index([userId])
}

model JoinRequest {
  id          String    @id @default(cuid())
  challengeId String
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role        String    // "designer" or "developer"
  experience  String    // Career/experience description
  status      String    @default("pending") // "pending", "approved", "rejected"
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([challengeId, userId])
  @@index([challengeId])
  @@index([userId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // "join_request", "request_approved", etc.
  title     String
  message   String
  link      String?  // Optional link to related page
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
}

model Event {
  id          String   @id @default(cuid())
  chatRoomId  String
  chatRoom    ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime?
  color       String   @default("#3b82f6") // Default blue color
  createdAt   DateTime @default(now())

  @@index([chatRoomId])
  @@index([userId])
  @@index([startDate])
}

model Whiteboard {
  id         String   @id @default(cuid())
  chatRoomId String
  chatRoom   ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  title      String
  content    String?  // JSON string representing whiteboard state
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([chatRoomId])
}

model GrowthTopic {
  id          String            @id @default(cuid())
  userId      String
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  description String?
  goal        String
  level       String            // "beginner", "intermediate", "advanced"
  duration    Int               // 학습 기간 (일)
  startDate   DateTime
  endDate     DateTime
  status      String            @default("active") // "active", "paused", "completed"
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  curriculum  Curriculum[]
  progress    LearningProgress[]

  @@index([userId])
  @@index([status])
}

model Curriculum {
  id             String      @id @default(cuid())
  topicId        String
  topic          GrowthTopic @relation(fields: [topicId], references: [id], onDelete: Cascade)
  dayNumber      Int         // 몇 번째 날 (1, 2, 3...)
  date           DateTime    // 해당 날짜
  title          String      // 학습 주제 제목
  description    String      // 학습 내용 설명
  objectives     String      // JSON array: 학습 목표들
  content        String?     // AI가 생성한 슬라이드 내용 (JSON 형식)
  exercises      String?     // JSON array: 학습 퀴즈들
  resources      String?     // JSON array: 참고 자료들
  estimatedTime  Int         @default(60) // 예상 학습 시간 (분)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@unique([topicId, dayNumber])
  @@index([topicId])
  @@index([date])
}

model LearningProgress {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  topicId       String
  topic         GrowthTopic @relation(fields: [topicId], references: [id], onDelete: Cascade)
  dayNumber     Int
  date          DateTime
  status        String      @default("not_started") // "not_started", "in_progress", "completed"
  timeSpent     Int         @default(0) // 학습 시간 (초)
  notes         String?
  chatHistory   String?
  completedAt   DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([userId, topicId, dayNumber])
  @@index([userId])
  @@index([topicId])
  @@index([dayNumber])
}

model SearchHistory {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  query     String
  filters   String?  // JSON string: { category, aiProvider, sortOrder }
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String   // 팔로우하는 사용자
  follower    User     @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  followingId String   // 팔로우받는 사용자
  following   User     @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}
